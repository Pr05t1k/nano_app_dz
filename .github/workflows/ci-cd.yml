name: CI/CD Pipeline for Notes API

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test on ${{ matrix.os }} (Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests with coverage
      run: npm test
      env:
        CI: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4  # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –±—ã–ª–æ v2/v3
      with:
        name: test-results-${{ matrix.os }}-node-${{ matrix.node-version }}
        path: |
          coverage/
        retention-days: 7  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
    
    - name: Test server startup
      run: |
        echo "üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ ${{ matrix.os }} —Å Node ${{ matrix.node-version }}"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
        npm start &
        SERVER_PID=$!
        
        # –†–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –û–°
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          sleep 8  # Windows –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
        else
          sleep 4  # Linux/Mac –±—ã—Å—Ç—Ä–µ–µ
        fi
        
        # –ü–†–û–í–ï–†–ö–ê –î–õ–Ø WINDOWS
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º Windows —Å–µ—Ä–≤–µ—Ä..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º native Windows –∫–æ–º–∞–Ω–¥—ã
          if tasklist //FI "PID eq $SERVER_PID" > nul 2>&1; then
            echo "‚úÖ Windows: —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω"
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
            taskkill //PID $SERVER_PID //F > nul 2>&1 || echo "–ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω"
            exit 0
          else
            echo "‚ùå Windows: —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
        
        # –ü–†–û–í–ï–†–ö–ê –î–õ–Ø LINUX/MAC
        else
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º ${{ matrix.os }} —Å–µ—Ä–≤–µ—Ä..."
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
          if curl -s -f http://localhost:3000/api/health > /dev/null 2>&1; then
            echo "‚úÖ ${{ matrix.os }}: —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check"
            kill $SERVER_PID 2>/dev/null || true
            exit 0
          else
            echo "‚ùå ${{ matrix.os }}: —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ health check"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–æ—Ç—è –±—ã —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∂–∏–≤
            if kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ö†Ô∏è  –ù–æ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ –∂–∏–≤, –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å API"
            fi
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
        fi
  build:
    name: Build and verify
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install production dependencies only
      run: npm ci --only=production
    
    - name: Verify build
      run: |
        node -c src/server.js
        node -c src/app.js
        echo "‚úÖ Build verification passed"
        du -sh node_modules/
    
    - name: Create build artifact
      run: |
        mkdir -p dist
        cp -r src/ dist/
        cp package.json dist/
        cp package-lock.json dist/
        echo "Build: $(date)" > dist/build-info.txt
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
      with:
        name: production-build
        path: dist/
        retention-days: 7

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download build artifact
      uses: actions/download-artifact@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
      with:
        name: production-build
        path: ./deploy
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    # –í–∞—Ä–∏–∞–Ω—Ç –¥–µ–ø–ª–æ—è - –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω
    - name: Deploy via SSH (–ø—Ä–∏–º–µ—Ä)
      if: false  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ true, –∫–æ–≥–¥–∞ –Ω–∞—Å—Ç—Ä–æ–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã
      run: |
        echo "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
        echo "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub:"
        echo "1. DEPLOY_HOST"
        echo "2. DEPLOY_USER" 
        echo "3. DEPLOY_SSH_KEY"

  report:
    name: Generate CI/CD Report
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()
    
    steps:
    - name: Status report
      run: |
        echo "üìä CI/CD Report"
        echo "==============="
        echo "‚úÖ –í—Å–µ deprecated actions –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
        echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏:"
        echo "   - actions/checkout@v4"
        echo "   - actions/setup-node@v4"
        echo "   - actions/upload-artifact@v4"
        echo "   - actions/download-artifact@v4"
