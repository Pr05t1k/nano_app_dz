name: CI/CD Pipeline for Notes API

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# –†–∞–∑—Ä–µ—à–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ –¥–ª—è PR –∏ –∫–æ–Ω–∫—É—Ä–µ—Ç–Ω—ã–µ jobs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –û–° –∏ –≤–µ—Ä—Å–∏—è—Ö Node.js
  test:
    name: Test on ${{ matrix.os }} (Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]
        include:
          - os: ubuntu-latest
            test-command: npm test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter (basic check)
      run: |
        npx eslint src/ --ext .js || echo "ESLint not configured, skipping"
        echo "‚úÖ Basic syntax check passed"
    
    - name: Run tests with coverage
      run: npm test
      env:
        CI: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.os }}-node-${{ matrix.node-version }}
        path: |
          coverage/
    
    - name: Test server startup
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
        npm start &
        SERVER_PID=$!
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
        sleep 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          # –î–ª—è Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º curl –∏–∑ Git Bash –∏–ª–∏ PowerShell
          $response = Invoke-WebRequest -Uri "http://localhost:3000/api/health" -Method GET -UseBasicParsing
          if ($response.StatusCode -eq 200) {
            Write-Host "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          } else {
            Write-Host "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 1
          }
        else
          # –î–ª—è Linux/Mac
          if curl -s -f http://localhost:3000/api/health > /dev/null; then
            echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          else
            echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 1
          fi
        fi
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
        kill $SERVER_PID 2>/dev/null || true

  # Job 2: –°–±–æ—Ä–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  build:
    name: Build and verify
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install production dependencies only
      run: npm ci --only=production
    
    - name: Verify build
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
        node -c src/server.js
        node -c src/app.js
        echo "‚úÖ Build verification passed"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        du -sh node_modules/
    
    - name: Create build artifact
      run: |
        mkdir -p dist
        cp -r src/ dist/
        cp package.json dist/
        cp package-lock.json dist/
        echo "Build completed at $(date)" > dist/build-info.txt
        echo "Commit: ${{ github.sha }}" >> dist/build-info.txt
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: production-build
        path: dist/

  # Job 3: –î–µ–ø–ª–æ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    
    # –£—Å–ª–æ–≤–∏–µ: –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ main/master –≤–µ—Ç–∫—É
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.deployment-url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download build artifact
      uses: actions/download-artifact@v3
      with:
        name: production-build
        path: ./deploy
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    # –í–ê–†–ò–ê–ù–¢ –ê: –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ SSH –Ω–∞ –≤–∞—à VPS —Å–µ—Ä–≤–µ—Ä
    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Notes API..."
          
          cd /var/www/notes-api
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º PM2)
          pm2 stop notes-api || true
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
          sudo cp -r /tmp/deploy/* .
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          npm ci --only=production
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          pm2 start src/server.js --name notes-api --update-env
          pm2 save
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          sleep 3
          curl -f http://localhost:3000/api/health || exit 1
          
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://${{ secrets.DEPLOY_HOST }}:3000"
    
    # –í–ê–†–ò–ê–ù–¢ B: –î–µ–ø–ª–æ–π –Ω–∞ Railway (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
    # - name: Deploy to Railway
    #   uses: railwayapp/action@v1.0.0
    #   with:
    #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
    #     service: notes-api
    
    - name: Verify deployment
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è..."
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if curl -s -f "${{ secrets.DEPLOY_URL }}/api/health" > /dev/null; then
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 0
          fi
          
          echo "–ü–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ..."
          sleep 5
          attempt=$((attempt + 1))
        done
        
        echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–æ –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
        exit 1

  # Job 4: –û—Ç—á–µ—Ç –æ —Å—Ç–∞—Ç—É—Å–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  report:
    name: Generate CI/CD Report
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()
    
    steps:
    - name: Status report
      run: |
        echo "üìä CI/CD Pipeline Report"
        echo "========================"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Trigger: ${{ github.event_name }}"
        echo "Timestamp: $(date)"
        echo ""
        echo "Job Status:"
        echo "- Test: ${{ needs.test.result }}"
        echo "- Build: ${{ needs.build.result }}"
        echo "- Deploy: ${{ needs.deploy.result }}"
        
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
          echo "‚úÖ –í—Å–µ —ç—Ç–∞–ø—ã CI –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        else
          echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —ç—Ç–∞–ø—ã CI –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã"
          exit 1
        fi
