name: CI/CD Pipeline for Notes API

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test on ${{ matrix.os }} (Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests with coverage
      run: npm test
      env:
        CI: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4  # ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –±—ã–ª–æ v2/v3
      with:
        name: test-results-${{ matrix.os }}-node-${{ matrix.node-version }}
        path: |
          coverage/
        retention-days: 7  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
    
    - name: Test server startup
      shell: bash  # –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–ù–ê–Ø –°–¢–†–û–ß–ö–ê
      run: |
        echo "=== –¢–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ ${{ matrix.os }} ==="
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
        npm start > server.log 2>&1 &
        SERVER_PID=$!
        echo "PID: $SERVER_PID"
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ (Windows –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏)
        WAIT_TIME=5
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          WAIT_TIME=10
          echo "Windows: –∂–¥–µ–º $WAIT_TIME —Å–µ–∫—É–Ω–¥..."
        else
          echo "${{ matrix.os }}: –∂–¥–µ–º $WAIT_TIME —Å–µ–∫—É–Ω–¥..."
        fi
        
        sleep $WAIT_TIME
        
        # –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏–º, –∂–∏–≤ –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
        if kill -0 $SERVER_PID 2>/dev/null; then
          echo "‚úÖ –£–°–ü–ï–•: –°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω –Ω–∞ ${{ matrix.os }}"
          
          # –ü—Ä–æ–±—É–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
          kill $SERVER_PID 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è"
          
          # –î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥
          echo "--- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞ ---"
          tail -10 server.log 2>/dev/null || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          echo "--- –ö–æ–Ω–µ—Ü –ª–æ–≥–∞ ---"
          
          exit 0
        else
          echo "‚ùå –û–®–ò–ë–ö–ê: –°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ ${{ matrix.os }}"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          echo "--- –ü–æ–ª–Ω—ã–π –ª–æ–≥ —Å–µ—Ä–≤–µ—Ä–∞ ---"
          cat server.log 2>/dev/null || echo "–õ–æ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          echo "--- –ö–æ–Ω–µ—Ü –ª–æ–≥–∞ ---"
          
          exit 1
        fi
  build:
    name: Build and verify
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install production dependencies only
      run: npm ci --only=production
    
    - name: Verify build
      run: |
        node -c src/server.js
        node -c src/app.js
        echo "‚úÖ Build verification passed"
        du -sh node_modules/
    
    - name: Create build artifact
      run: |
        mkdir -p dist
        cp -r src/ dist/
        cp package.json dist/
        cp package-lock.json dist/
        echo "Build: $(date)" > dist/build-info.txt
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
      with:
        name: production-build
        path: dist/
        retention-days: 7

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download build artifact
      uses: actions/download-artifact@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ v4
      with:
        name: production-build
        path: ./deploy
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    # –í–∞—Ä–∏–∞–Ω—Ç –¥–µ–ø–ª–æ—è - –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω
    - name: Deploy via SSH (–ø—Ä–∏–º–µ—Ä)
      if: false  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ true, –∫–æ–≥–¥–∞ –Ω–∞—Å—Ç—Ä–æ–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã
      run: |
        echo "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
        echo "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub:"
        echo "1. DEPLOY_HOST"
        echo "2. DEPLOY_USER" 
        echo "3. DEPLOY_SSH_KEY"

  report:
    name: Generate CI/CD Report
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()
    
    steps:
    - name: Status report
      run: |
        echo "üìä CI/CD Report"
        echo "==============="
        echo "‚úÖ –í—Å–µ deprecated actions –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
        echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏:"
        echo "   - actions/checkout@v4"
        echo "   - actions/setup-node@v4"
        echo "   - actions/upload-artifact@v4"
        echo "   - actions/download-artifact@v4"
